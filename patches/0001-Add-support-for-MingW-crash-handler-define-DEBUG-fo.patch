From 151a048473a515bb93fbe5848f3ffc4dca65486e Mon Sep 17 00:00:00 2001
From: Bernd Wachter <bwachter-tmw@lart.info>
Date: Thu, 28 Jan 2010 12:49:16 +0100
Subject: [PATCH] Add support for MingW crash handler; define DEBUG for debug builds

---
 src/CMakeLists.txt |    8 ++++++++
 src/main.cpp       |    4 ++++
 2 files changed, 12 insertions(+), 0 deletions(-)

diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index e101db0..be7b2bd 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -18,6 +18,14 @@ IF (ENABLE_NLS)
     SET(FLAGS "${FLAGS} -DENABLE_NLS=1")
 ENDIF()
 
+IF (CMAKE_BUILD_TYPE)
+    STRING(TOLOWER ${CMAKE_BUILD_TYPE} CMAKE_BUILD_TYPE_TOLOWER)
+    IF((CMAKE_BUILD_TYPE_TOLOWER MATCHES debug) OR
+       (CMAKE_BUILD_TYPE_TOLOWER MATCHES relwithdebinfo))
+        SET(FLAGS "${FLAGS} -DDEBUG")
+    ENDIF()
+ENDIF()
+
 IF (WIN32)
     SET(EXTRA_LIBRARIES ws2_32 winmm)
     FIND_PACKAGE(LibIntl REQUIRED)
diff --git a/src/main.cpp b/src/main.cpp
index af1057a..6454b12 100644
--- a/src/main.cpp
+++ b/src/main.cpp
@@ -722,6 +722,10 @@ static void initXML()
 /** Main */
 int main(int argc, char *argv[])
 {
+#if defined(DEBUG) && defined(WIN32)
+    // load mingw crash handler. Won't fail if dll is not present.
+    LoadLibrary("exchndl.dll");
+#endif
     // Parse command line options
     Options options;
     parseOptions(argc, argv, options);
-- 
1.5.6.5

