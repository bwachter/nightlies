From 51a25360b2db8c6b76e896bbfec819e10a104a89 Mon Sep 17 00:00:00 2001
From: Bernd Wachter <bwachter-tmw@lart.info>
Date: Sat, 23 Jan 2010 21:56:45 +0100
Subject: [PATCH] Add win32 rc handling to cmake; fix icon path

---
 src/CMakeLists.txt |   20 ++++++++++++++++++++
 src/mana-ea.rc     |   23 +++++++++++++++++++++++
 src/mana.rc        |    8 ++++----
 3 files changed, 47 insertions(+), 4 deletions(-)
 create mode 100644 src/mana-ea.rc

diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index c06f7d9..4bcdc7b 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -45,6 +45,22 @@ INCLUDE_DIRECTORIES(
     ${GUICHAN_INCLUDE_DIR}
     )
 
+# enable rc-handling with mingw
+# most likely this part can be kicked out with some later cmake version
+IF (MINGW)
+    FIND_PATH(MINGW_INCLUDE_DIR windows.h $ENV{INCLUDE})
+    IF (MINGW_INCLUDE_DIR)
+        MESSAGE(STATUS "Found mingw headers: ${MINGW_INCLUDE_DIR}")
+        INCLUDE_DIRECTORIES(${MINGW_INCLUDE_DIR})
+    ELSE()
+        MESSAGE(FATAL_ERROR "Unable to find mingw headers. Required for windres")
+    ENDIF()
+    SET(CMAKE_RC_COMPILER_INIT windres)
+    ENABLE_LANGUAGE(RC)
+    SET(CMAKE_RC_COMPILE_OBJECT
+      "<CMAKE_RC_COMPILER> <FLAGS> <DEFINES> -O coff -o <OBJECT> <SOURCE>")
+ENDIF()
+
 # Fix some stuff that gets not hidden by mainline modules
 MARK_AS_ADVANCED(PHYSFS_INCLUDE_DIR)
 MARK_AS_ADVANCED(PHYSFS_LIBRARY)
@@ -544,6 +560,10 @@ SET(SRCS_MANA
     net/manaserv/tradehandler.h
     )
 
+IF (WIN32)
+    SET(SRCS_MANA ${SRCS_MANA} mana.rc)
+    SET(SRCS_EA ${SRCS_EA} mana-ea.rc)
+ENDIF ()
 
 SET (PROGRAMS mana mana-ea)
 
diff --git a/src/mana-ea.rc b/src/mana-ea.rc
new file mode 100644
index 0000000..12068ea
--- /dev/null
+++ b/src/mana-ea.rc
@@ -0,0 +1,23 @@
+#include <windows.h> // include for version info constants
+
+#include "winver.h"
+
+A ICON MOVEABLE PURE LOADONCALL DISCARDABLE "../data/icons/mana.ico"
+
+1 VERSIONINFO
+FILEVERSION VER_MAJOR,VER_MINOR,VER_RELEASE,VER_BUILD
+PRODUCTVERSION VER_MAJOR,VER_MINOR,VER_RELEASE,VER_BUILD
+//FILETYPE VFT_APP
+{
+    BLOCK "StringFileInfo" {
+        BLOCK "040904E4" {
+            VALUE "CompanyName", "The Mana Development Team"
+            VALUE "FileVersion", PACKAGE_VERSION
+            VALUE "FileDescription", "Mana (Eathena)"
+            VALUE "LegalCopyright", "2004-2010 (C)"
+            VALUE "OriginalFilename", "mana-ea.exe"
+            VALUE "ProductName", "Mana MMORPG Client"
+            VALUE "ProductVersion", PACKAGE_VERSION
+        }
+    }
+}
diff --git a/src/mana.rc b/src/mana.rc
index 62dd9ec..1da5f41 100644
--- a/src/mana.rc
+++ b/src/mana.rc
@@ -2,22 +2,22 @@
 
 #include "winver.h"
 
-A ICON MOVEABLE PURE LOADONCALL DISCARDABLE "data/icons/mana.ico"
+A ICON MOVEABLE PURE LOADONCALL DISCARDABLE "../data/icons/mana.ico"
 
 1 VERSIONINFO
 FILEVERSION VER_MAJOR,VER_MINOR,VER_RELEASE,VER_BUILD
 PRODUCTVERSION VER_MAJOR,VER_MINOR,VER_RELEASE,VER_BUILD
-FILETYPE VFT_APP {
+//FILETYPE VFT_APP
+{
     BLOCK "StringFileInfo" {
         BLOCK "040904E4" {
             VALUE "CompanyName", "The Mana Development Team"
             VALUE "FileVersion", PACKAGE_VERSION
             VALUE "FileDescription", "Mana"
-            VALUE "LegalCopyright", "2004-2009 (C)"
+            VALUE "LegalCopyright", "2004-2010 (C)"
             VALUE "OriginalFilename", "mana.exe"
             VALUE "ProductName", "Mana MMORPG Client"
             VALUE "ProductVersion", PACKAGE_VERSION
         }
     }
 }
-
-- 
1.5.6.5

