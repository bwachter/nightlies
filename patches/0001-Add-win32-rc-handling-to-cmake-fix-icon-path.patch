From ae069c3003f5b1ea85ead6f2bb49d540771b456d Mon Sep 17 00:00:00 2001
From: Bernd Wachter <bwachter-tmw@lart.info>
Date: Sat, 23 Jan 2010 21:23:11 +0100
Subject: [PATCH] Add win32 rc handling to cmake; fix icon path

---
 src/CMakeLists.txt |   20 ++++++++++++++++++++
 src/mana-ea.rc     |   23 +++++++++++++++++++++++
 src/mana.rc        |    8 ++++----
 3 files changed, 47 insertions(+), 4 deletions(-)
 create mode 100644 src/mana-ea.rc

diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index c06f7d9..58543e2 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -21,6 +21,21 @@ ELSEIF (CMAKE_SYSTEM_NAME STREQUAL SunOS)
     SET(EXTRA_LIBRARIES intl)
 ENDIF()
 
+# enable rc-handling with mingw
+# most likely this part can be kicked out with some later cmake version
+IF (MINGW)
+    FIND_PATH(MINGW_INCLUDE_DIR windows.h $ENV{INCLUDE})
+    IF (MINGW_INCLUDE_DIR)
+        MESSAGE(STATUS "Found mingw headers: ${MINGW_INCLUDE_DIR}")
+    ELSE()
+        MESSAGE(STATUS "Unable to find mingw headers. Depending on your setup this might be bad.")
+    ENDIF()
+    SET(CMAKE_RC_COMPILER_INIT windres)
+    ENABLE_LANGUAGE(RC)
+    SET(CMAKE_RC_COMPILE_OBJECT
+      "<CMAKE_RC_COMPILER> <FLAGS> <DEFINES> -O coff -o <OBJECT> <SOURCE>")
+ENDIF()
+
 SET(GUICHAN_COMPONENTS "SDL")
 FIND_PACKAGE(Guichan REQUIRED ${GUICHAN_COMPONENTS})
 
@@ -43,6 +58,7 @@ INCLUDE_DIRECTORIES(
     ${CURL_INCLUDE_DIR}
     ${LIBXML2_INCLUDE_DIR}
     ${GUICHAN_INCLUDE_DIR}
+    ${MINGW_INCLUDE_DIR}
     )
 
 # Fix some stuff that gets not hidden by mainline modules
@@ -544,6 +560,10 @@ SET(SRCS_MANA
     net/manaserv/tradehandler.h
     )
 
+IF (WIN32)
+    SET(SRCS_MANA ${SRCS_MANA} mana.rc)
+    SET(SRCS_EA ${SRCS_EA} mana-ea.rc)
+ENDIF ()
 
 SET (PROGRAMS mana mana-ea)
 
diff --git a/src/mana-ea.rc b/src/mana-ea.rc
new file mode 100644
index 0000000..12068ea
--- /dev/null
+++ b/src/mana-ea.rc
@@ -0,0 +1,23 @@
+#include <windows.h> // include for version info constants
+
+#include "winver.h"
+
+A ICON MOVEABLE PURE LOADONCALL DISCARDABLE "../data/icons/mana.ico"
+
+1 VERSIONINFO
+FILEVERSION VER_MAJOR,VER_MINOR,VER_RELEASE,VER_BUILD
+PRODUCTVERSION VER_MAJOR,VER_MINOR,VER_RELEASE,VER_BUILD
+//FILETYPE VFT_APP
+{
+    BLOCK "StringFileInfo" {
+        BLOCK "040904E4" {
+            VALUE "CompanyName", "The Mana Development Team"
+            VALUE "FileVersion", PACKAGE_VERSION
+            VALUE "FileDescription", "Mana (Eathena)"
+            VALUE "LegalCopyright", "2004-2010 (C)"
+            VALUE "OriginalFilename", "mana-ea.exe"
+            VALUE "ProductName", "Mana MMORPG Client"
+            VALUE "ProductVersion", PACKAGE_VERSION
+        }
+    }
+}
diff --git a/src/mana.rc b/src/mana.rc
index 62dd9ec..1da5f41 100644
--- a/src/mana.rc
+++ b/src/mana.rc
@@ -2,22 +2,22 @@
 
 #include "winver.h"
 
-A ICON MOVEABLE PURE LOADONCALL DISCARDABLE "data/icons/mana.ico"
+A ICON MOVEABLE PURE LOADONCALL DISCARDABLE "../data/icons/mana.ico"
 
 1 VERSIONINFO
 FILEVERSION VER_MAJOR,VER_MINOR,VER_RELEASE,VER_BUILD
 PRODUCTVERSION VER_MAJOR,VER_MINOR,VER_RELEASE,VER_BUILD
-FILETYPE VFT_APP {
+//FILETYPE VFT_APP
+{
     BLOCK "StringFileInfo" {
         BLOCK "040904E4" {
             VALUE "CompanyName", "The Mana Development Team"
             VALUE "FileVersion", PACKAGE_VERSION
             VALUE "FileDescription", "Mana"
-            VALUE "LegalCopyright", "2004-2009 (C)"
+            VALUE "LegalCopyright", "2004-2010 (C)"
             VALUE "OriginalFilename", "mana.exe"
             VALUE "ProductName", "Mana MMORPG Client"
             VALUE "ProductVersion", PACKAGE_VERSION
         }
     }
 }
-
-- 
1.5.6.5

